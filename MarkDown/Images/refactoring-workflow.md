# リファクタリングワークフロー図

```
┌──────────────────────────────────────────────────────────────────────┐
│                     リファクタリングの基本フロー                     │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────┐                                                    │
│  │ コード分析   │ ← 現状把握                                         │
│  │ と問題特定   │                                                    │
│  └──────┬──────┘                                                    │
│         │                                                           │
│         ▼                                                           │
│  ┌─────────────┐                                                    │
│  │ テストの整備 │ ← 安全網の構築                                     │
│  │ と実行       │                                                    │
│  └──────┬──────┘                                                    │
│         │                                                           │
│         ▼                                                           │
│  ┌─────────────┐                                                    │
│  │ 小さな改善   │ ← 段階的な変更                                     │
│  │ を実施       │                                                    │
│  └──────┬──────┘                                                    │
│         │                                                           │
│         ▼                                                           │
│  ┌─────────────┐                                                    │
│  │ テスト実行   │ ← 動作確認                                         │
│  │ と確認       │                                                    │
│  └──────┬──────┘                                                    │
│         │                                                           │
│         ▼                                                           │
│  ┌─────────────┐     NG                                             │
│  │ 改善完了？   │ ─────┐                                            │
│  └──────┬──────┘      │                                            │
│         │OK           │                                            │
│         ▼             │                                            │
│  ┌─────────────┐      │                                            │
│  │ コミット     │      │                                            │
│  └─────────────┘      │                                            │
│                        │                                            │
│         ┌──────────────┘                                            │
│         ▼                                                           │
│  ┌─────────────┐                                                    │
│  │ 問題の修正   │                                                    │
│  │ または復旧   │                                                    │
│  └──────┬──────┘                                                    │
│         │                                                           │
│         └────────┐                                                  │
│                  ▼                                                  │
│          (テスト実行に戻る)                                          │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│                   リファクタリングの段階的アプローチ                 │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ Phase 1: 準備段階                                                    │
│ ┌──────────────────────────────────────────────────────────────────┐ │
│ │ 1. 現状分析                                                      │ │
│ │    ├─ コードの理解                                               │ │
│ │    ├─ 問題点の特定                                               │ │
│ │    └─ 影響範囲の調査                                             │ │
│ │                                                                  │ │
│ │ 2. テスト整備                                                    │ │
│ │    ├─ 既存テストの確認                                           │ │
│ │    ├─ 不足テストの追加                                           │ │
│ │    └─ テストカバレッジの確保                                     │ │
│ │                                                                  │ │
│ │ 3. 安全確認                                                      │ │
│ │    ├─ 全テストの実行                                             │ │
│ │    ├─ 動作確認                                                   │ │
│ │    └─ バックアップの作成                                         │ │
│ └──────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ Phase 2: 実行段階                                                    │
│ ┌──────────────────────────────────────────────────────────────────┐ │
│ │ 4. 小さな改善の繰り返し                                          │ │
│ │    ├─ 一度に一つの変更                                           │ │
│ │    ├─ 動作確認                                                   │ │
│ │    └─ 頻繁なコミット                                             │ │
│ │                                                                  │ │
│ │ 5. 継続的検証                                                    │ │
│ │    ├─ 各変更後のテスト実行                                       │ │
│ │    ├─ 機能確認                                                   │ │
│ │    └─ 性能確認（必要に応じて）                                   │ │
│ └──────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ Phase 3: 完了段階                                                    │
│ ┌──────────────────────────────────────────────────────────────────┐ │
│ │ 6. 最終確認                                                      │ │
│ │    ├─ 全体的なテスト実行                                         │ │
│ │    ├─ 設計目標の達成確認                                         │ │
│ │    └─ ドキュメントの更新                                         │ │
│ │                                                                  │ │
│ │ 7. 成果の評価                                                    │ │
│ │    ├─ 品質指標の測定                                             │ │
│ │    ├─ 保守性の改善確認                                           │ │
│ │    └─ 次回への知見の蓄積                                         │ │
│ └──────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│                    リファクタリング手法の分類                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 構造的リファクタリング                メソッドレベル                 │
│ ┌─────────────────────┐         ┌─────────────────────┐             │
│ │ • クラスの抽出         │         │ • メソッドの抽出     │             │
│ │ • クラスの統合         │   ←→   │ • メソッドの統合     │             │
│ │ • 継承の導入           │         │ • 引数の簡約化       │             │
│ │ • デリゲートの導入     │         │ • 条件分岐の整理     │             │
│ └─────────────────────┘         └─────────────────────┘             │
│            ↕                               ↕                       │
│ システムレベル                     ネーミング                        │
│ ┌─────────────────────┐         ┌─────────────────────┐             │
│ │ • アーキテクチャ変更   │         │ • 意味のある命名     │             │
│ │ • 依存関係の整理       │   ←→   │ • 命名の統一         │             │
│ │ • レイヤー分離         │         │ • 概念の明確化       │             │
│ │ • モジュール化         │         │ • 誤解を招く名前修正 │             │
│ └─────────────────────┘         └─────────────────────┘             │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│                        リファクタリングの原則                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│ 🔴 Red-Green-Refactor サイクル                                       │
│ ┌──────────────────────────────────────────────────────────────────┐ │
│ │ Test (Red) → Implementation (Green) → Refactor → Repeat         │ │
│ │                                                                  │ │
│ │ • テストファーストで安全性を確保                                 │ │
│ │ • 動作確認後に構造改善                                           │ │
│ │ • 継続的な品質向上                                               │ │
│ └──────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ 📏 小さな変更の積み重ね                                              │
│ ┌──────────────────────────────────────────────────────────────────┐ │
│ │ • Baby Steps - 一度に一つずつ                                    │ │
│ │ • 頻繁なコミット                                                 │ │
│ │ • 早期の問題発見                                                 │ │
│ └──────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│ 🛡️ 安全第一                                                          │
│ ┌──────────────────────────────────────────────────────────────────┐ │
│ │ • 十分なテストカバレッジ                                         │ │
│ │ • 動作確認の徹底                                                 │ │
│ │ • 復旧可能性の確保                                               │ │
│ └──────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────┘
```