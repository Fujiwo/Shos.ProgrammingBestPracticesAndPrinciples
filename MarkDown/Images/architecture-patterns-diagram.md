# アーキテクチャパターンと実践的設計

## 設計パターンの階層構造

```
┌────────────────────────────────────────────────────────────────────┐
│                    アーキテクチャレベル                             │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  レイヤードアーキテクチャ        マイクロサービス                   │
│  ┌─────────────────────┐      ┌─────────────────────┐             │
│  │  Presentation       │      │ Service A  Service B │             │
│  │  ─────────────────  │      │ ┌───────┐  ┌───────┐ │             │
│  │  Business Logic     │ →    │ │ API   │  │ API   │ │             │
│  │  ─────────────────  │      │ │ Logic │  │ Logic │ │             │
│  │  Data Access        │      │ │ Data  │  │ Data  │ │             │
│  │  ─────────────────  │      │ └───────┘  └───────┘ │             │
│  │  Database           │      └─────────────────────┘             │
│  └─────────────────────┘                                          │
│                                                                    │
│  ヘキサゴナルアーキテクチャ      CQRS + Event Sourcing             │
│  ┌─────────────────────┐      ┌─────────────────────┐             │
│  │    ┌─────────┐      │      │ Commands ─→ Events  │             │
│  │ ←──│  Port   │      │      │     │        │      │             │
│  │    │ Adapter │      │ →    │     ▼        ▼      │             │
│  │    │ (HTTP)  │      │      │ Write Model Read Model│             │
│  │    └─────────┘      │      │ ┌─────────┐ ┌─────────┐│             │
│  │      Domain Core    │      │ │Event    │ │View     ││             │
│  │    ┌─────────┐      │      │ │Store    │ │Store    ││             │
│  │ ←──│  Port   │      │      │ └─────────┘ └─────────┘│             │
│  │    │ Adapter │      │      └─────────────────────┘             │
│  │    │  (DB)   │      │                                          │
│  │    └─────────┘      │                                          │
│  └─────────────────────┘                                          │
└────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────┐
│                      設計パターンレベル                            │
├────────────────────────────────────────────────────────────────────┤
│                                                                    │
│  生成パターン              構造パターン              振る舞いパターン │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│  │ Factory         │    │ Adapter         │    │ Strategy        │ │
│  │ Builder         │    │ Decorator       │    │ Observer        │ │
│  │ Singleton       │    │ Facade          │    │ Command         │ │
│  │ Prototype       │    │ Proxy           │    │ State           │ │
│  │ Abstract Factory│    │ Composite       │    │ Template Method │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘ │
│         │                       │                       │         │
│         └───────────────────────┼───────────────────────┘         │
│                                 ▼                                 │
│                    ┌─────────────────────┐                        │
│                    │   実装パターン      │                        │
│                    │ ─────────────────   │                        │
│                    │ • Repository        │                        │
│                    │ • Unit of Work      │                        │
│                    │ • Dependency        │                        │
│                    │   Injection         │                        │
│                    │ • MVC/MVP/MVVM     │                        │
│                    └─────────────────────┘                        │
└────────────────────────────────────────────────────────────────────┘
```

## 依存関係の管理

### 依存関係逆転原則の実装

```
┌──────────────────────────────────────────────────────────────────┐
│                       従来の設計（問題あり）                     │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────┐                                              │
│  │HighLevelModule │                                              │
│  │ ────────────── │                                              │
│  │ +doSomething() │                                              │
│  └────────┬───────┘                                              │
│           │ depends on                                           │
│           ▼                                                      │
│  ┌────────────────┐                                              │
│  │LowLevelModule  │                                              │
│  │ ────────────── │                                              │
│  │ +method()      │                                              │
│  └────────────────┘                                              │
│                                                                  │
│  問題点：                                                        │
│  • 上位モジュールが下位モジュールに依存                          │
│  • テストが困難                                                  │
│  • 変更の伝播                                                    │
└──────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│                      改善後の設計（DIP適用）                     │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────┐          ┌────────────────┐                  │
│  │HighLevelModule │          │  IInterface    │                  │
│  │ ────────────── │ depends  │ ────────────── │                  │
│  │ +doSomething() │ ───────→ │ +method()      │                  │
│  └────────────────┘    on    └───────┬────────┘                  │
│                                       │                          │
│                                       │ implements               │
│                                       ▼                          │
│                              ┌────────────────┐                  │
│                              │LowLevelModule  │                  │
│                              │ ────────────── │                  │
│                              │ +method()      │                  │
│                              └────────────────┘                  │
│                                                                  │
│  利点：                                                          │
│  • 依存関係が逆転                                                │
│  • テストが容易（Mock化可能）                                    │
│  • 変更に強い設計                                                │
└──────────────────────────────────────────────────────────────────┘
```

## 実践的なコード構造

### Clean Architectureの実装例

```
┌──────────────────────────────────────────────────────────────────┐
│                        Clean Architecture                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Frameworks & Drivers                    │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │ │
│  │ │     Web     │ │ Databases   │ │ External    │           │ │
│  │ │ Controllers │ │ (SQL, NoSQL)│ │ Services    │           │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                               │                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 Interface Adapters                         │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │ │
│  │ │ Controllers │ │ Gateways    │ │ Presenters  │           │ │
│  │ │ (API)       │ │ (Repository)│ │ (ViewModels)│           │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                               │                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   Application                              │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │ │
│  │ │ Use Cases   │ │ Interactors │ │ Application │           │ │
│  │ │ (Business)  │ │ (Workflows) │ │ Services    │           │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                               │                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                     Enterprise                             │ │
│  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │ │
│  │ │ Entities    │ │ Value       │ │ Domain      │           │ │
│  │ │ (Domain)    │ │ Objects     │ │ Services    │           │ │
│  │ └─────────────┘ └─────────────┘ └─────────────┘           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  依存関係の方向：外側 → 内側                                     │
│  • 内側の層は外側の層について知らない                             │
│  • ビジネスルールは技術詳細から独立                               │
│  • テスタブルで保守しやすい設計                                   │
└──────────────────────────────────────────────────────────────────┘
```

## パフォーマンス考慮事項

### キャッシュ戦略パターン

```
┌──────────────────────────────────────────────────────────────────┐
│                        キャッシュパターン                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│ Cache-Aside Pattern          Read-Through Pattern                │
│ ┌─────────────────────┐     ┌─────────────────────┐              │
│ │ 1. アプリケーション │     │ 1. アプリケーション │              │
│ │    データを要求     │ →   │    データを要求     │              │
│ │ 2. キャッシュ確認   │     │ 2. キャッシュ確認   │              │
│ │ 3. miss時にDBアクセス│     │ 3. miss時は自動的に │              │
│ │ 4. データをキャッシュ│     │    データを取得     │              │
│ └─────────────────────┘     └─────────────────────┘              │
│                                                                  │
│ Write-Through Pattern        Write-Behind Pattern                │
│ ┌─────────────────────┐     ┌─────────────────────┐              │
│ │ 1. データ更新       │     │ 1. キャッシュ更新   │              │
│ │ 2. キャッシュ更新   │ →   │ 2. 非同期でDB更新   │              │
│ │ 3. DB更新           │     │ 3. 遅延書き込み     │              │
│ └─────────────────────┘     └─────────────────────┘              │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

## エラーハンドリング戦略

### 例外処理のパターン

| パターン | 適用場面 | 実装方法 | 利点 |
|----------|----------|----------|------|
| **Fail Fast** | 不正な入力検知 | 早期チェック | 問題の早期発見 |
| **Graceful Degradation** | 外部サービス障害 | フォールバック処理 | ユーザー体験の維持 |
| **Circuit Breaker** | 外部依存の障害 | 一時的な遮断 | システム保護 |
| **Retry Pattern** | 一時的な障害 | 再試行ロジック | 復旧の自動化 |
| **Bulkhead Pattern** | リソース分離 | 独立したプール | 障害の分離 |